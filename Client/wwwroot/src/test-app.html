<link rel="import" href="../lib/polymer/polymer.html">
<link rel="import" href="../lib/google-map/google-map.html">
<link rel="import" href="../lib/geo-location/geo-location.html">
<link rel="import" href="../lib/paper-tabs/paper-tabs.html">
<link rel="import" href="../lib/iron-pages/iron-pages.html">
<link rel="import" href="../lib/paper-button/paper-button.html">
<link rel="import" href="../lib/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="point-add.html">
<link rel="import" href="point-remove.html">
<link rel="import" href="point-edit.html">
<link rel="import" href="point-way.html">


<dom-module id="test-app">
    <template>
        <style is="custom-style" include="iron-flex">
            :host {
                display: block;
            }

            google-map {
                height: 600px;
            }
            paper-input {
                width: 200px;
                margin: 5px;
            }
            paper-button.green {
                background-color: var(--paper-green-500);
                color: white;
            }

            .content {
                width: 100%;
            }
        </style>

        <div class="map">
            <paper-button class="green" on-tap="userLocation">User location</paper-button>
            <geo-location latitude="{{userLat}}"
                          longitude="{{userLng}}"></geo-location>
                <google-map id="map" map="{{map}}" latitude="{{mapLat}}" longitude="{{mapLng}}" fit-to-markers>
                    <google-map-marker latitude="{{markerLat}}" longitude="{{markerLng}}"
                                       draggable="true" title="You are here!"
                                       hidden="[[hideLocationMarker]]"></google-map-marker>
                    <google-map-marker latitude="{{selectedMarker.latitude}}" longitude="{{selectedMarker.longitude}}"
                                       draggable="true"
                                       hidden="[[hideEditMarker]]"></google-map-marker>
                    <template is="dom-repeat" items="[[points]]" as="marker">
                        <google-map-marker latitude="[[marker.latitude]]" longitude="[[marker.longitude]]"
                                           title="[[marker.notes]]" id="[[marker.id]]"
                                           hidden="[[hideMarker]]"
                                           click-events="true" on-google-map-marker-click="markerClicked">[[marker.notes]]</google-map-marker>
                    </template>
                </google-map>
        </div>
        <div class="content">
            <paper-tabs selected="{{selected}}" align-bottom>
                <paper-tab>Show all</paper-tab>
                <paper-tab>Add point</paper-tab>
                <paper-tab>Way</paper-tab>
                <paper-tab>Remove point</paper-tab>
                <paper-tab>Edit point</paper-tab>
            </paper-tabs>
            <iron-pages selected="{{selected}}">
                <div class="page">
                    <iron-ajax id="ajaxGetAll"
                               url="http://localhost:51589/api/point/"
                               content-type="application/json"
                               method="GET"
                               handle-as="json"
                               on-response="getAllResponse">
                    </iron-ajax>
                    <template is="dom-repeat" items="[[points]]" as="point">
                        <div class="layout horizontal">
                            <paper-input Label="Notes" value="{{point.notes}}" readonly></paper-input>
                            <paper-input Label="Date" value="{{point.date}}" readonly></paper-input>
                            <paper-input label="Latitude" value="{{point.latitude}}" readonly></paper-input>
                            <paper-input label="Longitude" value="{{point.longitude}}" readonly></paper-input>
                        </div>
                    </template>
                </div>
                <div class="page">
                    <point-add latitude="{{markerLat}}" longitude="{{markerLng}}" map="{{map}}"></point-add>
                </div>
                <div class="page">
                    <point-way id="way" map="{{map}}" points="{{points}}"></point-way>
                </div>
                <div class="page">
                    <point-remove selected-id="[[selectedMarkerId]]" points="[[points]]"></point-remove>
                </div>
                <div class="page">
                    <point-edit selected-marker="[[selectedMarker]]"></point-edit>
                </div>
            </iron-pages>
        </div>


    </template>
    <script>
        Polymer({
            is: 'test-app',
            properties: {
                userLat: { type: Number },
                userLng: { type: Number },
                mapLat: { type: Number },
                mapLng: { type: Number },
                markerLat: { type: Number },
                markerLng: { type: Number },
                points: { type: Array },
                selectedMarker: { type: Object },
                selectedMarkerId: { type: Number, value: 0 },
                hideMarker: { type: Boolean, value: false },
                hideLocationMarker: { type: Boolean, value: false },
                hideEditMarker: { type: Boolean, value: true }
            },
            observers: [
                'userLocationChanged(userLat, userLng)',
                'tabChanged(selected)'
            ],
            userLocationChanged: function (userLat, userLng) {
                if (userLat == null || userLng == null)
                    return;
                this.mapLat = userLat;
                this.mapLng = userLng;
                if (!this.markerLat && !this.markerLng) {
                    this.markerLat = userLat;
                    this.markerLng = userLng;
                }
            },
            tabChanged: function (selected) {
                this.hideMarker = true;
                this.hideLocationMarker = true;
                this.hideEditMarker = true;
                this.$.way.hideWay();
                if (selected == 0)
                    this.hideMarker = false;
                if (selected == 1)
                    this.hideLocationMarker = false;
                if (selected == 2)
                    this.$.way.showWay();
                if (selected == 3)
                    this.hideMarker = false;
                if (selected == 4)
                    this.hideEditMarker = false;
            },
            userLocation: function () {
                this.mapLat = this.userLat;
                this.mapLng = this.userLng;
            },
            attached: function () {
                this.$.ajaxGetAll.generateRequest();
            },
            getAllResponse: function (data) {
                this.points = data.detail.response;
                for (var i = 0; i < this.points.length; i++){
                    var item = this.points[i];
                }
                this.map.fitToMarkers();
            },
            markerClicked: function (e, detail, sender) {
                console.log("markerClick");
                if (this.selectedMarker)
                this.selectedMarker.animation = null;
                this.selectedMarker = e.srcElement;
                this.selectedMarker.animation = "BOUNCE";
                this.selectedMarkerId = e.srcElement.id;
            }
        });
    </script>
</dom-module>
